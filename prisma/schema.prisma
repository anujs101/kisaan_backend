// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// generator client {
//   provider = "prisma-client"
//   output   = "../generated/prisma"
// }

// datasource db {
//   provider = "postgresql"
// }
//------------------------------------------------------------

// prisma/schema.prisma
// Production-ready Prisma schema for Neon + PostGIS
// - Set DATABASE_URL in env
// - Note: geom uses Unsupported because Prisma doesn't have PostGIS types
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ------------------------
// ENUMS
// ------------------------

enum UploadStatus {
  PENDING
  COMPLETED
  FAILED
  PROCESSING
}

enum VerificationStatus {
  PENDING
  VERIFIED
  LOW_CONFIDENCE
  UNVERIFIED
  FLAGGED
  REJECTED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_MORE_INFO
}

// ------------------------
// USER + AUTH MODELS
// ------------------------

model User {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  phone          String   @unique
  phoneVerified  Boolean  @default(false) @map("phone_verified")

  email          String?  @unique
  emailVerified  Boolean  @default(false) @map("email_verified")

  fullName       String?  @map("full_name")
  role           String?

  // Local auth
  passwordHash   String?  @map("password_hash")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt      @map("updated_at")

  // Relations (inverse/list sides)
  refreshTokens  RefreshToken[] @relation("user_refresh_tokens")
  uploads        Upload[]       @relation("user_uploads")
  images         Image[]        @relation("user_images")
  reviews        ImageReview[]  @relation("user_reviews")
  damageCases    DamageCase[]   @relation("user_damage_cases")

  @@map("users")
}

/*
 * Refresh tokens (child side defines relation + referential action)
 */
model RefreshToken {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  userId     String   @db.Uuid
  user       User     @relation(fields: [userId], references: [id], name: "user_refresh_tokens", onDelete: Cascade)

  tokenHash  String   @map("token_hash")
  userAgent  String?  @map("user_agent")
  ip         String?  @db.Inet
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId], map: "idx_refresh_tokens_user_id")
  @@map("refresh_tokens")
}

/*
 * AuthSession — temporary session created after /auth/request-otp
 * (list side must NOT specify onDelete; child side will)
 */
model AuthSession {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  phone       String
  purpose     String
  metadata    Json?
  clientNonce String?
  requestIp   String?   @map("request_ip")
  userAgent   String?   @map("user_agent")
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  phoneOtps   PhoneOtp[] @relation("authsession_phone_otps")

  @@index([phone, purpose], map: "idx_authsession_phone_purpose")
  @@map("auth_sessions")
}

/*
 * PhoneOtp — single OTP attempt, tied to sessionId
 * Using Twilio Verify: do NOT store plaintext codes. Store provider meta instead.
 * This is the child side of the authSession relation and can specify onDelete.
 */
model PhoneOtp {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  phone            String
  purpose          String

  attempts         Int      @default(0)
  used             Boolean  @default(false)

  expiresAt        DateTime @map("expires_at")
  createdAt        DateTime @default(now()) @map("created_at")

  // Twilio provider fields
  provider         String?   @map("provider")          // e.g., 'twilio'
  providerMeta     Json?     @map("provider_meta")
  messageSid       String?   @map("message_sid")
  verificationSid  String?   @map("verification_sid")

  authSessionId    String?   @db.Uuid @map("auth_session_id")
  authSession      AuthSession? @relation(fields: [authSessionId], references: [id], name: "authsession_phone_otps", onDelete: Cascade)

  @@index([phone, purpose], map: "idx_phoneotp_phone_purpose")
  @@index([expiresAt], map: "idx_phoneotp_expires_at")
  @@map("phone_otps")
}

// ------------------------
// UPLOADS / IMAGES
// ------------------------

model Upload {
  id                 String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  userId             String?       @db.Uuid
  user               User?         @relation(fields: [userId], references: [id], name: "user_uploads", onDelete: SetNull)

  localUploadId      String        @db.Uuid @map("local_upload_id")
  filename           String?
  filesize           BigInt?       @db.BigInt
  hasCaptureCoords   Boolean?      @map("has_capture_coords")
  signedParams       Json?         @map("signed_params")
  cloudinaryPublicId String?       @map("cloudinary_public_id")
  uploadStatus       UploadStatus? @map("upload_status")
  deviceMeta         Json?         @map("device_meta")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt       @map("updated_at")

  images             Image[]       @relation("upload_images")

  @@index([userId], map: "idx_uploads_user_id")
  @@unique([localUploadId], map: "ux_uploads_local_upload_id")
  @@map("uploads")
}

model Image {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  userId                String?  @db.Uuid
  user                  User?    @relation(fields: [userId], references: [id], name: "user_images", onDelete: SetNull)

  uploadId              String?  @db.Uuid
  upload                Upload?  @relation(fields: [uploadId], references: [id], name: "upload_images")

  localUploadId         String   @db.Uuid @map("local_upload_id")
  cloudinaryPublicId    String   @map("cloudinary_public_id")
  storageUrl            String   @map("storage_url")
  thumbnailUrl          String?  @map("thumbnail_url")

  exif                  Json
  exifLat               Float?   @map("exif_lat")
  exifLon               Float?   @map("exif_lon")
  exifTimestamp         DateTime? @map("exif_timestamp")

  captureLat            Float?   @map("capture_lat")
  captureLon            Float?   @map("capture_lon")
  captureTimestamp      DateTime? @map("capture_timestamp")

  uploadLat             Float?   @map("upload_lat")
  uploadLon             Float?   @map("upload_lon")
  uploadTimestamp       DateTime? @map("upload_timestamp")

  state                 String?
  district              String?
  block                 String?
  village               String?

  detectedCropId        String?      @db.Uuid @map("detected_crop_id")
  detectedCrop          Crop?        @relation(fields: [detectedCropId], references: [id], name: "image_detected_crop")

  detectedStageId       String?      @db.Uuid @map("detected_stage_id")
  detectedStage         GrowthStage? @relation(fields: [detectedStageId], references: [id], name: "image_detected_stage")

  qualityScore          Float?       @map("quality_score")
  imageHash             String?      @unique @map("image_hash")

  geom                  Unsupported("geography(Point,4326)")

  verificationStatus    VerificationStatus @default(PENDING) @map("verification_status")
  verificationReason    String?            @map("verification_reason")
  verificationDistanceM Float?             @map("verification_distance_m")

  createdAt             DateTime     @default(now()) @map("created_at")

  analytics             ImageAnalytics[]
  reviews               ImageReview[]
  damageCaseImages      DamageCaseImage[]

  @@index([verificationStatus, createdAt], map: "idx_images_status_created_at")
  @@index([state, district], map: "idx_images_state_district")
  @@index([detectedCropId], map: "idx_images_detected_crop")
  @@unique([localUploadId], map: "ux_images_local_upload_id")
  @@map("images")
}

model ImageAnalytics {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  imageId      String   @db.Uuid
  image        Image    @relation(fields: [imageId], references: [id])
  modelName    String?  @map("model_name")
  modelVersion String?  @map("model_version")
  results      Json
  qualityScore Float?   @map("quality_score")
  processedAt  DateTime @default(now()) @map("processed_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([imageId], map: "idx_image_analytics_image_id")
  @@index([processedAt], map: "idx_image_analytics_processed_at")
  @@map("image_analytics")
}

model ImageReview {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  imageId    String   @db.Uuid
  image      Image    @relation(fields: [imageId], references: [id])
  reviewerId String?  @db.Uuid
  reviewer   User?    @relation(fields: [reviewerId], references: [id], name: "user_reviews")

  status     ReviewStatus? @map("status")
  reason     String?
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([imageId], map: "idx_image_reviews_image_id")
  @@index([status], map: "idx_image_reviews_status")
  @@map("image_reviews")
}

model Crop {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  code      String?  @unique
  seasons   String[] @default([])
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")

  stages    GrowthStage[] @relation("crop_stages")
  images    Image[]       @relation("image_detected_crop")
  damageCases DamageCase[] @relation("crop_damage_cases")

  @@map("crops")
}

model GrowthStage {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cropId     String   @db.Uuid
  crop       Crop     @relation(fields: [cropId], references: [id], name: "crop_stages")
  name       String?
  stageOrder Int?     @map("stage_order")
  description String?
  createdAt  DateTime @default(now()) @map("created_at")

  images     Image[]  @relation("image_detected_stage")

  @@unique([cropId, stageOrder], map: "ux_growth_stage_crop_order")
  @@map("growth_stages")
}

model DamageCategory {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String?
  code           String?  @unique
  defaultSeverity String? @map("default_severity")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("damage_categories")
}

model DamageCase {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdBy      String?  @db.Uuid @map("created_by")
  createdByUser  User?    @relation(fields: [createdBy], references: [id], name: "user_damage_cases", onDelete: SetNull)
  regionState    String?  @map("region_state")
  regionDistrict String?  @map("region_district")
  summary        String?
  cropId         String?  @db.Uuid
  crop           Crop?    @relation(fields: [cropId], references: [id], name: "crop_damage_cases")
  severity       String?
  status         String?  @default("open")
  estimatedAreaHa Float?  @map("estimated_area_ha")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt       @map("updated_at")

  images         DamageCaseImage[]

  @@index([regionState, regionDistrict], map: "idx_damage_cases_region")
  @@index([status], map: "idx_damage_cases_status")
  @@map("damage_cases")
}

model DamageCaseImage {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  damageCaseId String   @db.Uuid @map("damage_case_id")
  damageCase   DamageCase @relation(fields: [damageCaseId], references: [id])
  imageId      String   @db.Uuid
  image        Image    @relation(fields: [imageId], references: [id])

  @@index([damageCaseId], map: "idx_damage_case_images_case")
  @@map("damage_case_images")
}

model AuditLog {
  id        BigInt   @id @default(autoincrement()) @db.BigInt
  eventType String   @map("event_type")
  userId    String?  @db.Uuid
  relatedId String?  @db.Uuid @map("related_id")
  payload   Json?
  ip        String?  @db.Inet
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([relatedId], map: "idx_audit_logs_related")
  @@index([createdAt], map: "idx_audit_logs_time")
  @@map("audit_logs")
}